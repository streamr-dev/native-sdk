name: "cached install"
description: "install dependencies, build and cache result, or restore from cache if present"

runs:
  using: "composite"
  steps:
    - name: cache homedir
      id: cache-homedir
      uses: actions/cache/restore@v4
      with:
        key: ${{ runner.arch }}-${{ runner.os }}-cache-homedir1-${{ hashFiles('./vcpkg.json') }}
        path: |
          ~/.cache/vcpkg/archives
    - name: cache vcpkg installed
      id: cache-vcpkg-installed
      uses: actions/cache/restore@v4
      with:
        key: ${{ runner.arch }}-${{ runner.os }}-cache-vcpkg-installed1-${{ hashFiles('./vcpkg.json') }}
        path: |
          ./build/vcpkg_installed
    - name: install-prerequisities
      run:
        source install-prerequisities.sh
      shell: bash
    - name: install
      run: |
        ./install.sh --prod ${ARCHFLAGS:-} || (cat /Users/runner/work/native-sdk/native-sdk/vcpkg/buildtrees/libdatachannel/config-arm64-osx-out.log && exit 1)
      shell: bash
    - name: cache homedir save
      id: cache-homedir-save
      if: always()
      uses: actions/cache/save@v4
      with:
        key: ${{ runner.arch }}-${{ runner.os }}-cache-homedir1-${{ hashFiles('./vcpkg.json') }}
        path: |
          ~/.cache/vcpkg/archives
    - name: cache vcpkg installed save
      id: cache-vcpkg-installed-save
      if: always()
      uses: actions/cache/save@v4
      with:
        key: ${{ runner.arch }}-${{ runner.os }}-cache-vcpkg-installed1-${{ hashFiles('./vcpkg.json') }}
        path: |
          ./build/vcpkg_installed
    - name: Commit compiled binaries
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add packages/streamr-libstreamrproxyclient/dist
        git add packages/streamr-libstreamrproxyclient/wrappers/go
        git commit -m "Automatically compiled binaries"
        git pull --rebase --no-edit
        git push --no-verify
      shell: bash

