name: "cached install"
description: "install dependencies, build and cache result, or restore from cache if present"

runs:
  using: "composite"
  steps:
    - name: install-prerequisities
      run:
        source install-prerequisities.sh
      shell: bash
    - name: install
      run: |
        ./install.sh --prod ${ARCHFLAGS:-} || (
          for target in arm64-osx x64-osx x64-linux arm64-linux arm64-android arm64-ios; do
            BASE_DIR="/Users/runner/work/native-sdk/native-sdk/vcpkg/buildtrees/libdatachannel"
            
            # Function to print file if it exists
            print_if_exists() {
              if [ -f "$1" ]; then
                echo "=== $2 ==="
                cat "$1"
              fi
            }
            
            print_if_exists "$BASE_DIR/config-$target-dbg-CMakeCache.txt.log" "config-$target-dbg-CMakeCache.txt.log"
            print_if_exists "$BASE_DIR/config-$target-rel-CMakeCache.txt.log" "config-$target-rel-CMakeCache.txt.log"
            print_if_exists "$BASE_DIR/config-$target-dbg-CMakeConfigureLog.yaml.log" "config-$target-dbg-CMakeConfigureLog.yaml.log"
            print_if_exists "$BASE_DIR/config-$target-rel-CMakeConfigureLog.yaml.log" "config-$target-rel-CMakeConfigureLog.yaml.log"
            print_if_exists "$BASE_DIR/config-$target-rel-ninja.log" "config-$target-rel-ninja.log"
            print_if_exists "$BASE_DIR/config-$target-out.log" "config-$target-out.log"
            print_if_exists "../../$target-dbg/CMakeCache.txt" "../../$target-dbg/CMakeCache.txt"
          done
          exit 1
        )
      shell: bash

