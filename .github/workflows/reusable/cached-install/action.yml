name: "cached install"
description: "install dependencies, build and cache result, or restore from cache if present"

runs:
  using: "composite"
  steps:
    - name: install-prerequisities
      run:
        source install-prerequisities.sh
      shell: bash
    - name: install
      run: |
        ./install.sh --prod ${ARCHFLAGS:-} || (
          echo "=== config-arm64-android-dbg-CMakeCache.txt.log ===" && \
          cat /Users/runner/work/native-sdk/native-sdk/vcpkg/buildtrees/libdatachannel/config-arm64-android-dbg-CMakeCache.txt.log && \
          echo "=== config-arm64-android-rel-CMakeCache.txt.log ===" && \
          cat /Users/runner/work/native-sdk/native-sdk/vcpkg/buildtrees/libdatachannel/config-arm64-android-rel-CMakeCache.txt.log && \
          echo "=== config-arm64-android-dbg-CMakeConfigureLog.yaml.log ===" && \
          cat /Users/runner/work/native-sdk/native-sdk/vcpkg/buildtrees/libdatachannel/config-arm64-android-dbg-CMakeConfigureLog.yaml.log && \
          echo "=== config-arm64-android-rel-CMakeConfigureLog.yaml.log ===" && \
          cat /Users/runner/work/native-sdk/native-sdk/vcpkg/buildtrees/libdatachannel/config-arm64-android-rel-CMakeConfigureLog.yaml.log && \
          echo "=== config-arm64-android-rel-ninja.log ===" && \
          cat /Users/runner/work/native-sdk/native-sdk/vcpkg/buildtrees/libdatachannel/config-arm64-android-rel-ninja.log && \
          echo "=== config-arm64-android-out.log ===" && \
          cat /Users/runner/work/native-sdk/native-sdk/vcpkg/buildtrees/libdatachannel/config-arm64-android-out.log && \
          echo "=== ../../arm64-android-dbg/CMakeCache.txt ===" && \
          cat ../../arm64-android-dbg/CMakeCache.txt && \
          exit 1
        )
      shell: bash
