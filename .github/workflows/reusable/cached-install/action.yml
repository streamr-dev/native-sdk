name: "cached install"
description: "install dependencies, build and cache result, or restore from cache if present"

runs:
  using: "composite"
  steps:
    - name: install-prerequisities
      run:
        source install-prerequisities.sh
      shell: bash
    - name: install
      run: |
        ./install.sh --prod ${ARCHFLAGS:-} || (
          for target in arm64-osx x64-osx x64-linux arm64-linux arm64-android arm64-ios; do
            echo "=== config-$target-dbg-CMakeCache.txt.log ===" && \
            cat /Users/runner/work/native-sdk/native-sdk/vcpkg/buildtrees/libdatachannel/config-$target-dbg-CMakeCache.txt.log || true && \
            echo "=== config-$target-rel-CMakeCache.txt.log ===" && \
            cat /Users/runner/work/native-sdk/native-sdk/vcpkg/buildtrees/libdatachannel/config-$target-rel-CMakeCache.txt.log || true && \
            echo "=== config-$target-dbg-CMakeConfigureLog.yaml.log ===" && \
            cat /Users/runner/work/native-sdk/native-sdk/vcpkg/buildtrees/libdatachannel/config-$target-dbg-CMakeConfigureLog.yaml.log || true && \
            echo "=== config-$target-rel-CMakeConfigureLog.yaml.log ===" && \
            cat /Users/runner/work/native-sdk/native-sdk/vcpkg/buildtrees/libdatachannel/config-$target-rel-CMakeConfigureLog.yaml.log || true && \
            echo "=== config-$target-rel-ninja.log ===" && \
            cat /Users/runner/work/native-sdk/native-sdk/vcpkg/buildtrees/libdatachannel/config-$target-rel-ninja.log || true && \
            echo "=== config-$target-out.log ===" && \
            cat /Users/runner/work/native-sdk/native-sdk/vcpkg/buildtrees/libdatachannel/config-$target-out.log || true && \
            echo "=== ../../$target-dbg/CMakeCache.txt ===" && \
            cat ../../$target-dbg/CMakeCache.txt || true
          done
          exit 1
        )
      shell: bash
